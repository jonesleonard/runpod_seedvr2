name: Build, Push, and Deploy

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
    paths:
      - 'src/upscale/**'
      - 'src/runpod/**'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Docker image tag (default: latest)'
        required: false
        default: 'latest'
      seedvr2_ref:
        description: 'SeedVR2 version to use'
        required: false
        default: 'v2.5.23'

env:
  IMAGE_NAME: seedvr2-upscaler

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy-network-volume-models:
    name: Deploy Network Volume and Models
    uses: ./.github/workflows/deploy-network-volume-models.yml
    with:
      runpod_rest_api_base_url: ${{ vars.RUNPOD_REST_API_BASE_URL }}
      network_volume_name: 'seedvr2-models-volume'
      network_volume_size: '50'
      template_name: 'seedvr2_model_downloader_template'
      presign_expires_seconds: '3600'
      aws_role_arn: ${{ vars.NETWORK_VOLUME_MODELS_AWS_ROLE_ARN }}
      data_center_id: ${{ vars.NETWORK_VOLUME_MODELS_DATA_CENTER_ID }}
      image_name: ${{ vars.NETWORK_VOLUME_MODELS_IMAGE_NAME }}
      models_bucket: ${{ vars.NETWORK_VOLUME_MODELS_BUCKET }}
      vae_key: ${{ vars.NETWORK_VOLUME_MODELS_VAE_KEY }}
      dit_key: ${{ vars.NETWORK_VOLUME_MODELS_DIT_KEY }}
      tag: ${{ github.event.inputs.tag || 'latest' }}
      python_version: ${{ vars.PYTHON_VERSION }}
    secrets:
      RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
  build-and-push:
    name: Build and Push Docker Image
    uses: ./.github/workflows/docker-build-push.yml
    with:
      dockerhub_username: ${{ vars.DOCKERHUB_USERNAME }}
      image_name: ${{ vars.UPSCALER_IMAGE_NAME }}
      tag: ${{ github.event.inputs.tag || 'latest' }}
      seedvr2_ref: ${{ github.event.inputs.seedvr2_ref || vars.SEEDVR2_REF || 'v2.5.23' }}
    secrets:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
  
  create-update-runpod-template:
    name: Create/Update RunPod Template
    needs: build-and-push
    uses: ./.github/workflows/runpod-template.yml
    with:
      runpod_rest_api_base_url: ${{ vars.RUNPOD_REST_API_BASE_URL }}
      python_version: ${{ vars.PYTHON_VERSION }}
      full_image_name: ${{ needs.build-and-push.outputs.full_image_name }}
      template_name: 'seedvr2_upscaler'
    secrets:
      RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
  
  create-update-endpoint:
    name: Create/Update RunPod Endpoint
    needs: create-update-runpod-template
    uses: ./.github/workflows/runpod-endpoint.yml
    with:
      environment: "dev"
      endpoint_name: 'seedvr2-upscaler-endpoint'
      runpod_rest_api_base_url: ${{ vars.RUNPOD_REST_API_BASE_URL }}
      python_version: ${{ vars.PYTHON_VERSION }}
      template_id: ${{ needs.create-update-runpod-template.outputs.template_id }}
    secrets:
      RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
